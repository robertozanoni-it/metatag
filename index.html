<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizzatore Meta Tag - V2 Elementor Fix</title>
    <!-- 
        VERSIONE OTTIMIZZATA PER ELEMENTOR / WIDGET HTML.
        - RISOLTO: Problema cursore e clic sul pulsante "Analizza HTML" (uso di !important e listener robusto).
        - MIGLIORATO: Reattivit√† generale all'avvio.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'indigo-600': '#4f46e5',
                        'indigo-700': '#4338ca',
                        'indigo-50': '#f5f3ff',
                    },
                },
            },
        }
    </script>
    <!-- jsPDF √® mantenuto per l'export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .loading-dot {
            animation: dot-flicker 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes dot-flicker {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .tab-button {
            padding: 0.75rem 1rem; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 100px;
            color: #d1d5db; 
            transition: all 0.2s ease-in-out;
        }
        .tab-button:hover {
            color: #ffffff; 
        }
        .tab-button.active {
            background-color: #fff;
            color: #4f46e5; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 640px) {
            .tab-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem; 
                min-width: unset;
                flex-grow: 1; 
            }
        }
        .score-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
        }
        
        /* START: FIX CURSORE E INTERAZIONE (USO DI !IMPORTANT PER ELEMENTOR) */
        #analyze-button {
            pointer-events: auto !important; 
            transition: all 0.15s ease-in-out;
        }
        #analyze-button[disabled] {
            cursor: not-allowed !important;
            opacity: 0.5 !important;
        }
        #analyze-button:not([disabled]) {
            cursor: pointer !important;
        }
        /* END: FIX CURSORE E INTERAZIONE */
        
        /* Stili per l'anteprima SERP */
        .serp-link { color: #1a0dab; }
        .serp-url { color: #006621; }
        .serp-description { color: #545454; }

        /* Stili per le card Social */
        .social-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 100%; 
            margin: 1rem 0;
            min-height: 250px; 
        }
        .social-img {
            height: 150px; 
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-style: italic;
            padding: 10px;
            text-align: center;
        }
        .social-body { padding: 10px 12px; }
        .social-site { text-transform: uppercase; color: #777; font-size: 0.75rem; }
        .social-title { font-weight: bold; color: #1d2129; font-size: 1rem; }
        .social-description { color: #606770; font-size: 0.85rem; }

        /* Stili Bar Chart Nativi */
        .bar-chart-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .bar-wrapper {
            display: flex;
            align-items: center;
        }
        .bar-label {
            width: 80px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4a5568;
            flex-shrink: 0;
        }
        .bar-track {
            flex-grow: 1;
            height: 16px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-left: 0.5rem;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        <header class="text-center mb-6 p-4 sm:p-6 bg-white shadow-xl rounded-2xl">
            <h1 class="text-2xl sm:text-4xl font-extrabold text-indigo-700 mb-2">
                Analizzatore Meta Tag SEO Avanzato
            </h1>
            <p class="text-gray-600 text-sm sm:text-base">Incolla il codice sorgente HTML completo per ottenere un'analisi. (Versione Elementor Safe)</p>
        </header>

        <!-- Input Form and Feature Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 gap-4 mb-8">
            <!-- Input Card Span -->
            <div id="input-card" class="col-span-2 md:col-span-4 lg:col-span-4 bg-white p-4 sm:p-8 rounded-2xl shadow-xl">
                <div class="flex flex-col gap-4">
                    <textarea
                        id="html-input"
                        placeholder="Incolla qui il codice sorgente HTML completo della pagina (tutto, da <html> a </html>)..."
                        rows="6"
                        required
                        class="flex-grow p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:border-indigo-500 transition duration-150 font-mono text-sm"
                    ></textarea>
                    <button
                        id="analyze-button"
                        onclick="analyzeHtml()"
                        disabled 
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg hover:shadow-xl disabled:opacity-50"
                    >
                        Analizza HTML
                    </button>
                </div>
                <div id="error-message" class="mt-3 text-red-600 text-sm hidden"></div>
            </div>
            
            <!-- Feature Cards (Responisve grid: 2 colonne su mobile, 4 su tablet/desktop) -->
            <div onclick="scrollToTab('serp-preview')" class="bg-white p-4 rounded-xl shadow-lg cursor-pointer hover:shadow-indigo-300/50 transition duration-300 border-l-4 border-indigo-500">
                <p class="font-bold text-gray-700 text-sm">üîç Anteprima SERP</p>
                <p class="text-xs text-gray-500">Simulazione risultato Google.</p>
            </div>
            <div onclick="scrollToTab('social-preview')" class="bg-white p-4 rounded-xl shadow-lg cursor-pointer hover:shadow-indigo-300/50 transition duration-300 border-l-4 border-pink-500">
                <p class="font-bold text-gray-700 text-sm">üì± Social Preview</p>
                <p class="text-xs text-gray-500">Visualizza card FB/Twitter.</p>
            </div>
            <div onclick="scrollToTab('history')" class="bg-white p-4 rounded-xl shadow-lg cursor-pointer hover:shadow-indigo-300/50 transition duration-300 border-l-4 border-green-500">
                <p class="font-bold text-gray-700 text-sm">üìä Storico & Grafici</p>
                <p class="text-xs text-gray-500">Evoluzione delle metriche SEO.</p>
            </div>
            <div onclick="exportToPdf()" class="bg-white p-4 rounded-xl shadow-lg cursor-pointer hover:shadow-indigo-300/50 transition duration-300 border-l-4 border-yellow-500">
                <p class="font-bold text-gray-700 text-sm">üìÑ Export PDF</p>
                <p class="text-xs text-gray-500">Scarica il report professionale.</p>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="text-center p-8 hidden bg-white rounded-xl shadow-xl">
            <div class="flex justify-center items-center space-x-2">
                <div class="loading-dot w-4 h-4 bg-indigo-600 rounded-full"></div>
                <div class="loading-dot w-4 h-4 bg-indigo-600 rounded-full"></div>
                <div class="loading-dot w-4 h-4 bg-indigo-600 rounded-full"></div>
            </div>
            <p class="mt-4 text-indigo-600 font-medium text-lg">Analizzando e calcolando tutti i punteggi...</p>
        </div>

        <!-- Results Area -->
        <div id="results-container" class="bg-white p-4 sm:p-8 rounded-2xl shadow-xl hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-3">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-3 sm:mb-0">Risultati dell'Analisi</h2>
                <div id="global-score-display" class="score-circle">N/A</div>
            </div>
            <p id="analyzed-url-display" class="text-xs sm:text-sm text-gray-500 mb-6"></p>

            <!-- Tab Navigation (Responisve: flex-wrap per i tab) -->
            <div class="flex flex-wrap border-b border-gray-200 mb-6 -mx-1 sm:mx-0 bg-gray-800 rounded-lg shadow-lg p-2">
                <button class="tab-button active" data-tab="analysis" onclick="changeTab('analysis')">1. Analisi Completa</button>
                <button class="tab-button" data-tab="serp-preview" onclick="changeTab('serp-preview')">2. SERP</button>
                <button class="tab-button" data-tab="social-preview" onclick="changeTab('social-preview')">3. Social</button>
                <button class="tab-button" data-tab="recommendations" onclick="changeTab('recommendations')">4. Raccomandazioni</button>
                <button class="tab-button" data-tab="structured-data" onclick="changeTab('structured-data')">5. Schema.org</button>
                <button class="tab-button" data-tab="keywords" onclick="changeTab('keywords')">6. Keyword</button>
                <button class="tab-button" data-tab="history" onclick="changeTab('history')">7. Storico</button>
                <button class="tab-button" data-tab="checklist" onclick="changeTab('checklist')">8. Checklist</button>
            </div>

            <!-- TAB 1: Analisi Completa -->
            <div id="tab-analysis" class="tab-content">
                <div id="score-breakdown" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <!-- Score cards injected here -->
                </div>
                <div id="meta-results-tables">
                    <!-- Meta Tag Base, OG, Twitter tables injected here -->
                </div>
            </div>

            <!-- TAB 2: Anteprima SERP (Centrato su desktop, largo su mobile) -->
            <div id="tab-serp-preview" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Anteprima Risultato Google SERP</h3>
                <div id="serp-preview-content" class="p-4 border border-gray-200 rounded-xl shadow-inner max-w-xl mx-auto">
                    <p class="serp-url text-sm mb-1" id="serp-breadcrumb">simulazione-analisi/incollato/codice-sorgente</p>
                    <a href="#" class="serp-link text-xl font-medium" id="serp-title"></a>
                    <p class="serp-description text-sm mt-1" id="serp-description"></p>
                </div>
                <div class="mt-4 p-4 border rounded-xl max-w-xl mx-auto">
                    <p id="title-char-count" class="text-sm"></p>
                    <p id="desc-char-count" class="text-sm"></p>
                </div>
            </div>

            <!-- TAB 3: Anteprima Social (Responisve: 1 colonna su mobile, 3 su desktop) -->
            <div id="tab-social-preview" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Anteprime Condivisione Social</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div id="facebook-preview"></div>
                    <div id="twitter-preview"></div>
                    <div id="linkedin-preview"></div>
                </div>
            </div>
            
            <!-- TAB 4: Raccomandazioni -->
            <div id="tab-recommendations" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Raccomandazioni SEO Intelligenti</h3>
                <div id="recommendations-list" class="space-y-4">
                    <!-- Raccomandazioni iniettate qui -->
                </div>
            </div>

            <!-- TAB 5: Schema.org -->
            <div id="tab-structured-data" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Rilevamento Dati Strutturati (JSON-LD)</h3>
                <div id="structured-data-output" class="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm">
                    <p class="text-gray-500">Nessun dato strutturato JSON-LD trovato.</p>
                </div>
            </div>

            <!-- TAB 6: Keyword Analysis (Responisve: 1 colonna su mobile, 2 su desktop) -->
            <div id="tab-keywords" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Analisi e Densit√† Keyword</h3>
                <div id="keyword-analysis-output" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-2">Keyword Estratte (Title & Description)</h4>
                        <ul id="keyword-list" class="list-disc list-inside bg-gray-50 p-4 rounded-lg"></ul>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Statistiche Densit√† Keyword</h4>
                        <div id="density-stats" class="bg-gray-50 p-4 rounded-lg"></div>
                    </div>
                </div>
            </div>
            
            <!-- TAB 7: Storico & Grafici (Responisve: 1 colonna su mobile, 2 su desktop) -->
            <div id="tab-history" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Storico Analisi e Confronto Categorie</h3>
                <div id="history-charts" class="mb-8">
                    <!-- GRAFICO 1: Confronto Categorie (NATIVO HTML/TAILWIND) -->
                    <div class="p-4 border rounded-xl shadow-md mb-6">
                        <h4 class="text-lg font-semibold mb-3">Confronto Categorie (Ultima Analisi)</h4>
                        <div id="categoryComparisonChart" class="bar-chart-container">
                            <p class="text-gray-500">Esegui un'analisi per visualizzare il grafico.</p>
                        </div>
                    </div>
                    <!-- GRAFICO 2: Evoluzione Score (NATIVO HTML/TAILWIND) -->
                    <div class="p-4 border rounded-xl shadow-md">
                        <h4 class="text-lg font-semibold mb-3">Evoluzione Punteggio Generale (Ultimi 5)</h4>
                        <div id="scoreEvolutionChart">
                            <p class="text-gray-500">Esegui analisi multiple per visualizzare l'evoluzione.</p>
                        </div>
                    </div>
                </div>
                
                <h4 class="font-semibold mb-2">Analisi Precedenti</h4>
                <div id="history-list" class="space-y-2">
                    <!-- Storico iniettato qui -->
                </div>
            </div>

            <!-- TAB 8: Checklist SEO -->
            <div id="tab-checklist" class="tab-content hidden">
                <h3 class="text-xl font-bold mb-4">Checklist SEO Interattiva</h3>
                <div id="checklist-container" class="space-y-3 p-4 bg-gray-50 rounded-xl">
                    <div class="mb-4">
                        <div id="progress-bar-container" class="h-4 bg-gray-200 rounded-full">
                            <div id="progress-bar" class="h-4 bg-green-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <p id="progress-text" class="text-right text-sm mt-1 text-green-700 font-medium">0% Completato</p>
                    </div>
                    <!-- Items iniettati qui -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // Variabili globali
        const HISTORY_KEY = 'seo_analyzer_history';
        const CHECKLIST_KEY = 'seo_checklist_state';

        // --- Core Functions ---

        function getMetaContent(doc, attribute, value, contentAttr = 'content') {
            const selector = `meta[${attribute}="${value}"]`;
            const element = doc.querySelector(selector);
            return element ? element.getAttribute(contentAttr) : null;
        }

        function parseHtml(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const data = {};

            // 1. Meta Tag Base (1)
            data.title = doc.title || '';
            data.description = getMetaContent(doc, 'name', 'description') || '';
            data.keywords = getMetaContent(doc, 'name', 'keywords') || '';
            data.canonical = doc.querySelector('link[rel="canonical"]')?.href || '';
            data.robots = doc.querySelector('meta[name="robots"]') ? doc.querySelector('meta[name="robots"]').getAttribute('content') : 'N/A';
            data.viewport = getMetaContent(doc, 'name', 'viewport') || 'N/A';
            data.charset = doc.querySelector('meta[charset]')?.getAttribute('charset') || 'N/A';
            data.author = getMetaContent(doc, 'name', 'author') || 'N/A';
            data.lang = doc.querySelector('html')?.lang || 'N/A';
            data.contentType = getMetaContent(doc, 'http-equiv', 'Content-Type') || 'N/A';
            
            // 2. Open Graph (Facebook) (2)
            data.og_title = getMetaContent(doc, 'property', 'og:title') || '';
            data.og_description = getMetaContent(doc, 'property', 'og:description') || '';
            data.og_image = getMetaContent(doc, 'property', 'og:image') || '';
            data.og_url = getMetaContent(doc, 'property', 'og:url') || '';
            data.og_type = getMetaContent(doc, 'property', 'og:type') || '';
            data.og_site_name = getMetaContent(doc, 'property', 'og:site_name') || '';
            data.og_locale = getMetaContent(doc, 'property', 'og:locale') || '';

            // 3. Twitter Cards (3)
            data.twitter_card = getMetaContent(doc, 'name', 'twitter:card') || '';
            data.twitter_title = getMetaContent(doc, 'name', 'twitter:title') || '';
            data.twitter_description = getMetaContent(doc, 'name', 'twitter:description') || '';
            data.twitter_image = getMetaContent(doc, 'name', 'twitter:image') || '';
            data.twitter_site = getMetaContent(doc, 'name', 'twitter:site') || '';
            data.twitter_creator = getMetaContent(doc, 'name', 'twitter:creator') || '';

            // 7. Schema.org / Structured Data
            const jsonLdScripts = Array.from(doc.querySelectorAll('script[type="application/ld+json"]'));
            data.json_ld = jsonLdScripts.map(script => {
                try {
                    const parsed = JSON.parse(script.textContent);
                    const type = Array.isArray(parsed['@type']) ? parsed['@type'].join(', ') : parsed['@type'];
                    return { type: type || 'Sconosciuto', content: script.textContent };
                } catch (e) {
                    return { type: 'Errore Parsing', content: script.textContent };
                }
            });

            // Aggiunge dati di analisi locale
            data.analyzedUrl = 'Analisi Codice Incollato';
            data.timestamp = new Date().toISOString();

            return data;
        }

        function calculateScores(data) {
            const scores = {
                title: 0,
                description: 0,
                technical: 0,
                social: 0,
                general: 0
            };

            // Title Score (ottimale 30-70 caratteri)
            const titleLen = data.title.length;
            if (titleLen >= 30 && titleLen <= 70) scores.title = 100;
            else if (titleLen > 0 && titleLen < 30) scores.title = 50;
            else if (titleLen > 70 && titleLen <= 90) scores.title = 75;
            else scores.title = 20;
            
            // Description Score (ottimale 120-160 caratteri)
            const descLen = data.description.length;
            if (descLen >= 120 && descLen <= 160) scores.description = 100;
            else if (descLen > 0 && descLen < 120) scores.description = 60;
            else if (descLen > 160 && descLen <= 200) scores.description = 70;
            else scores.description = 10;
            
            // Technical Score (Canonical, Robots, Viewport, Charset)
            let techScore = 0;
            if (data.canonical && data.canonical.length > 0) { techScore += 25; }
            if (data.robots !== 'N/A' && data.robots.toLowerCase().includes('index')) { techScore += 25; }
            if (data.viewport !== 'N/A' && data.viewport.includes('width=device-width')) { techScore += 25; }
            if (data.charset.toUpperCase() === 'UTF-8') { techScore += 25; }
            scores.technical = Math.round(techScore);
            
            // Social Media Score (Open Graph & Twitter)
            let socialScore = 0;
            if (data.og_title && data.og_title.length > 0) { socialScore += 15; }
            if (data.og_description && data.og_description.length > 0) { socialScore += 15; }
            if (data.og_image && data.og_image.length > 0) { socialScore += 20; }
            if (data.twitter_card && data.twitter_card.length > 0) { socialScore += 20; }
            if (data.twitter_title && data.twitter_title.length > 0) { socialScore += 10; }
            if (data.twitter_image && data.twitter_image.length > 0) { socialScore += 10; }
            if (data.og_url && data.og_url.length > 0) { socialScore += 10; }
            scores.social = Math.round(socialScore);

            // Punteggio Generale (Media ponderata)
            scores.general = Math.round((scores.title * 0.25) + (scores.description * 0.25) + (scores.technical * 0.3) + (scores.social * 0.2));

            data.scores = scores;
            return data;
        }
        
        // --- Rendering Functions ---
        
        function updateGlobalScore(score) {
            const element = document.getElementById('global-score-display');
            element.textContent = score;
            let color = '';
            if (score < 50) color = 'bg-red-500';
            else if (score < 75) color = 'bg-yellow-500';
            else color = 'bg-green-500';
            element.className = 'score-circle ' + color;
        }

        function renderScoreBreakdown(scores) {
            const container = document.getElementById('score-breakdown');
            container.innerHTML = '';
            const scoreLabels = {
                title: 'Title Score',
                description: 'Description Score',
                technical: 'Meta Tecnici Score',
                social: 'Social Media Score',
                general: 'Punteggio Generale',
            };

            Object.keys(scores).forEach(key => {
                const score = scores[key];
                const label = key === 'general' ? 'Punteggio Generale' : scoreLabels[key];
                const color = score < 50 ? 'bg-red-500' : (score < 75 ? 'bg-yellow-500' : 'bg-green-500');
                
                const cardHtml = `
                    <div class="p-4 bg-white rounded-xl shadow-lg border-b-4 ${key === 'general' ? 'border-indigo-600 col-span-2 md:col-span-1' : 'border-gray-300'} transition duration-300 hover:shadow-xl">
                        <p class="text-sm font-medium text-gray-500">${label}</p>
                        <div class="text-2xl font-extrabold mt-1 flex items-center">
                            <span class="p-2 rounded-full text-white text-lg font-bold ${color} mr-3">${score}</span>
                            <span class="${score >= 75 ? 'text-green-600' : (score >= 50 ? 'text-yellow-600' : 'text-red-600')}">${score} / 100</span>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
            updateGlobalScore(scores.general);
        }

        function renderAnalysisTables(data) {
            const container = document.getElementById('meta-results-tables');
            container.innerHTML = '';

            const fieldGroups = [
                { title: 'Meta Tag Base (1)', dataKey: 'base', keys: ['title', 'description', 'keywords', 'canonical', 'robots', 'viewport', 'charset', 'author', 'lang', 'contentType'] },
                { title: 'Open Graph (Facebook) (2)', dataKey: 'og', keys: ['og_title', 'og_description', 'og_image', 'og_url', 'og_type', 'og_site_name', 'og_locale'] },
                { title: 'Twitter Cards (3)', dataKey: 'twitter', keys: ['twitter_card', 'twitter_title', 'twitter_description', 'twitter_image', 'twitter_site', 'twitter_creator'] }
            ];

            const keyMap = {
                title: 'Tag Title', description: 'Meta Description', canonical: 'URL Canonico', keywords: 'Meta Keywords', robots: 'Meta Robots', viewport: 'Viewport', charset: 'Charset', author: 'Author', lang: 'Language (lang)', contentType: 'Content-Type',
                og_title: 'og:title', og_description: 'og:description', og_image: 'og:image', og_url: 'og:url', og_type: 'og:type', og_site_name: 'og:site_name', og_locale: 'og:locale',
                twitter_card: 'twitter:card', twitter_title: 'twitter:title', twitter_description: 'twitter:description', twitter_image: 'twitter:image', twitter_site: 'twitter:site', twitter_creator: 'twitter:creator'
            };
            
            fieldGroups.forEach(group => {
                let tableHtml = `
                    <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-4 p-3 bg-indigo-50 rounded-lg">${group.title}</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse rounded-xl overflow-hidden shadow-md mb-8 min-w-[600px]">
                            <thead>
                                <tr class="bg-gray-200 text-gray-700">
                                    <th class="p-3 w-1/4 text-left">Meta Tag</th>
                                    <th class="p-3 w-3/4 text-left">Contenuto/Stato</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                group.keys.forEach(key => {
                    const value = data[key] || 'N/A';
                    const displayName = keyMap[key] || key;
                    const valueDisplay = value.length > 0 && value !== 'N/A' ? value : '<span class="italic text-yellow-600">Mancante / N/A</span>';
                    
                    let feedback = '';
                    let copyBtn = '';
                    if (key === 'title' || key === 'description') {
                        const len = value.length;
                        const optimal = key === 'title' ? [30, 70] : [120, 160];
                        
                        if (len > optimal[1]) { feedback = `‚ùå Troppo lungo (${len} car.)`; }
                        else if (len > 0 && len < optimal[0]) { feedback = `‚ö†Ô∏è Troppo corto (${len} car.)`; }
                        else if (len === 0) { feedback = `‚ùå Mancante`; }
                        else { feedback = `‚úÖ Ottimale (${len} car.)`; }
                        
                        copyBtn = `<button onclick="copyToClipboard('${value}', this)" class="ml-2 text-sm text-indigo-500 hover:text-indigo-700">üìã Copia</button>`;
                    } else if (key.includes('image') && value.length > 0) {
                        feedback = `‚úÖ Immagine Trovata`;
                    } else if (value.length > 0 && value !== 'N/A') {
                        feedback = '‚úÖ Presente';
                    } else {
                        feedback = '‚ö†Ô∏è Mancante';
                    }

                    tableHtml += `
                        <tr class="border-t hover:bg-gray-50">
                            <td class="p-3 font-medium text-gray-800">${displayName}</td>
                            <td class="p-3 break-all text-sm flex items-center justify-between">
                                <span class="flex-grow">${valueDisplay}</span>
                                <span class="ml-3 text-xs font-semibold ${feedback.startsWith('‚úÖ') ? 'text-green-600' : (feedback.startsWith('‚ùå') ? 'text-red-600' : 'text-yellow-600')} flex-shrink-0">
                                    (${feedback})
                                </span>
                                ${copyBtn}
                            </td>
                        </tr>
                    `;
                });

                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                container.innerHTML += tableHtml;
            });
        }
        
        function renderSerpPreview(data) {
            const MAX_TITLE = 60; 
            const MAX_DESC = 160; 
            
            const title = data.title;
            const description = data.description;
            
            const serpTitle = title.length > MAX_TITLE ? title.substring(0, MAX_TITLE) + '...' : title;
            const serpDescription = description.length > MAX_DESC ? description.substring(0, MAX_DESC) + '...' : description;

            document.getElementById('serp-title').textContent = serpTitle || 'Titolo Mancante';
            document.getElementById('serp-description').textContent = serpDescription || 'Descrizione Mancante o Troppo Corta';
            
            document.getElementById('title-char-count').innerHTML = `<strong>Title:</strong> ${title.length} caratteri (Ottimale: 30-70).`;
            document.getElementById('desc-char-count').innerHTML = `<strong>Description:</strong> ${description.length} caratteri (Ottimale: 120-160).`;
        }
        
        function renderSocialPreview(data) {
            const facebookContainer = document.getElementById('facebook-preview');
            const twitterContainer = document.getElementById('twitter-preview');
            const linkedinContainer = document.getElementById('linkedin-preview');

            if (!facebookContainer || !twitterContainer || !linkedinContainer) {
                console.error("Errore: Impossibile trovare i container per l'Anteprima Sociale.");
                return;
            }
            
            const mockUrl = 'https://mock-analysis-site.com/pasted-content';
            const mockSite = 'Analisi HTML';

            facebookContainer.innerHTML = createSocialCard('Facebook (Open Graph)', 'facebook-style', data.og_title, data.og_description, data.og_image, mockUrl, data.og_site_name || mockSite, data);
            twitterContainer.innerHTML = createSocialCard('Twitter (Card)', 'twitter-style', data.twitter_title || data.og_title, data.twitter_description || data.og_description, data.twitter_image || data.og_image, mockUrl, data.twitter_site || mockSite, data);
            linkedinContainer.innerHTML = createSocialCard('LinkedIn (Open Graph)', 'linkedin-style', data.og_title, data.og_description, data.og_image, mockUrl, data.og_site_name || mockSite, data);
        }

        function createSocialCard(platform, styleClass, title, description, imageUrl, url, siteName, data) {
            
            const displayTitle = title && title.length > 0 ? title : data.title || 'Titolo Generale Mancante';
            const displayDesc = description && description.length > 0 ? description : data.description || 'Descrizione Generale Mancante';
            const displaySite = siteName || 'Analisi Sorgente';
            
            const imageFound = imageUrl && imageUrl.length > 0;
            const imageText = imageFound ? 'Anteprima Img OG/Twitter Trovata (Non caricata)' : 'Nessuna Immagine OG/Twitter Trovata';
            const displayImage = `<div class="social-img w-full bg-indigo-50 border-b border-indigo-200">${imageText}</div>`;

            let statusBadge = '';
            const isOgTwitterPresent = (title && title.length > 0) || (description && description.length > 0) || imageFound;
            
            if (isOgTwitterPresent) {
                statusBadge = '<span class="text-sm font-bold text-green-600">‚úÖ Tag Social Dedicati Trovati</span>';
            } else if (data.title.length > 0 && data.description.length > 0) { 
                statusBadge = '<span class="text-sm font-bold text-yellow-600">‚ö†Ô∏è Usando Title/Description Base (Tag Social Mancanti)</span>';
            } else {
                statusBadge = '<span class="text-sm font-bold text-red-600">‚ùå Dati Social Critici Mancanti</span>';
            }

            return `
                <div>
                    <h4 class="font-bold text-lg mb-2 text-gray-700">${platform} Card</h4>
                    <div class="mb-3">${statusBadge}</div>
                    <div class="social-card ${styleClass}">
                        ${displayImage}
                        <div class="social-body">
                            <p class="social-site">${displaySite}</p>
                            <p class="social-title mt-1">${truncateString(displayTitle, 80)}</p>
                            <p class="social-description mt-1">${truncateString(displayDesc, 120)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStructuredData(data) {
            const container = document.getElementById('structured-data-output');
            
            if (data.json_ld.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nessun dato strutturato JSON-LD trovato. ‚ö†Ô∏è</p>';
                return;
            }

            let html = '<p class="text-green-600 font-medium mb-3">‚úÖ Trovati ' + data.json_ld.length + ' blocchi JSON-LD:</p>';
            data.json_ld.forEach((item, index) => {
                const badgeColor = item.type.includes('Errore') ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800';
                html += `
                    <div class="mb-4 p-3 border rounded-lg">
                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full ${badgeColor}">${item.type}</span>
                        <pre class="whitespace-pre-wrap mt-2 p-2 bg-white rounded-md border text-xs">${truncateString(item.content, 500)}</pre>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderKeywordAnalysis(data) {
            const titleWords = (data.title || '').toLowerCase().split(/\s+/).filter(w => w.length > 3);
            const descWords = (data.description || '').toLowerCase().split(/\s+/).filter(w => w.length > 3);
            const allWords = [...titleWords, ...descWords];
            const totalWords = allWords.length;

            const frequencyMap = allWords.reduce((acc, word) => {
                acc[word] = (acc[word] || 0) + 1;
                return acc;
            }, {});

            const sortedKeywords = Object.entries(frequencyMap)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10); 

            const keywordList = document.getElementById('keyword-list');
            keywordList.innerHTML = sortedKeywords.map(([word, count]) => {
                const density = totalWords > 0 ? (count / totalWords * 100).toFixed(2) : 0;
                return `<li class="hover:bg-gray-100 p-1 rounded">
                            <span class="font-bold text-indigo-700">${word}</span>: ${count} occorrenze (<span class="${density > 3 ? 'text-red-500' : 'text-green-600'}">${density}%</span> densit√†)
                        </li>`;
            }).join('');
            
            const densityStats = document.getElementById('density-stats');
            densityStats.innerHTML = `
                <p>Parole totali analizzate (Title & Desc): <span class="font-bold">${totalWords}</span></p>
                <p>Keyword uniche: <span class="font-bold">${Object.keys(frequencyMap).length}</span></p>
                <p class="mt-2 text-sm text-gray-600">
                    Suggerimento: Una densit√† ideale si aggira tra l'1% e il 3%.
                </p>
            `;
        }

        function renderRecommendations(data) {
            const container = document.getElementById('recommendations-list');
            container.innerHTML = '';
            const scores = data.scores;
            let recommendations = [];

            const addRec = (type, title, description) => {
                recommendations.push({ type, title, description });
            };

            // 1. Raccomandazioni basate sui punteggi
            if (scores.title < 75) {
                addRec('‚ö†Ô∏è Warning', 'Migliora il Title Tag', `Il punteggio del titolo √® basso (${scores.title}/100). Lunghezza attuale: ${data.title.length}. Obiettivo: 30-70 caratteri.`);
            } else if (scores.title < 100 && scores.title >= 75) {
                 addRec('üí° Suggerimento', 'Title Tag Quasi Perfetto', `Ottimo lavoro! Considera la lunghezza per evitare il troncamento in SERP (max 60 car. visuali).`);
            }
            if (scores.description < 75) {
                addRec('‚ùå Errore critico', 'Rivedi la Meta Description', `Il punteggio della descrizione √® critico (${scores.description}/100). Lunghezza attuale: ${data.description.length}. Obiettivo: 120-160 caratteri. Una buona descrizione aumenta il CTR.`);
            }
            if (scores.social < 75) {
                addRec('‚ö†Ô∏è Warning', 'Ottimizza i Meta Tag Social', `I tag Open Graph (Facebook) e Twitter sono incompleti. Assicurati che 'og:title', 'og:description' e 'og:image' siano presenti per migliorare la condivisione.`);
            }
            if (!data.canonical || data.canonical.length === 0) {
                 addRec('‚ùå Errore critico', 'URL Canonico Mancante', `L'URL canonico √® fondamentale per prevenire problemi di contenuto duplicato. Aggiungi il tag <link rel="canonical">.`);
            }

            // 2. Raccomandazioni basate sui dati strutturati
            if (data.json_ld.length === 0) {
                addRec('‚ùå Errore critico', 'Dati Strutturati Mancanti', 'Implementa i dati strutturati (JSON-LD) per il tuo tipo di contenuto (es. Article, Product, Organization) per migliorare i rich snippet in SERP.');
            }
            
            // 3. Feedback positivo
            if (scores.general > 80) {
                addRec('‚úÖ Feedback positivo', 'Analisi Generale Ottima', `Il punteggio generale di ${scores.general}/100 √® eccellente! Continua a monitorare e affina i dettagli.`);
            }
            
            // Render
            recommendations.forEach(rec => {
                const color = rec.type.includes('positivo') ? 'border-green-500' : (rec.type.includes('critico') ? 'border-red-500' : 'border-yellow-500');
                const icon = rec.type.includes('positivo') ? '‚úÖ' : (rec.type.includes('critico') ? '‚ùå' : '‚ö†Ô∏è');
                const titleColor = rec.type.includes('critico') ? 'text-red-700' : 'text-gray-800';
                
                container.innerHTML += `
                    <div class="p-4 bg-white rounded-xl shadow border-l-4 ${color}">
                        <p class="font-bold ${titleColor} mb-1">${icon} ${rec.title}</p>
                        <p class="text-sm text-gray-600">${rec.description}</p>
                    </div>
                `;
            });
        }

        // --- Storico & Grafici Nativi Leggeri ---

        function getHistory() {
            try {
                const history = localStorage.getItem(HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                console.error("Errore lettura storico da LocalStorage:", e);
                return [];
            }
        }

        function saveHistory(data) {
            const history = getHistory();
            const newEntry = {
                url: data.analyzedUrl,
                timestamp: data.timestamp,
                scores: data.scores,
                title: data.title,
                description: data.description,
                og_image: data.og_image,
                json_ld_count: data.json_ld.length,
            };
            // Limita a 5 elementi per semplicit√† di visualizzazione
            history.unshift(newEntry);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 5)));
        }

        function renderHistoryTab() {
            const history = getHistory();
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';

            if (history.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 italic">Nessuna analisi salvata nello storico.</p>';
                document.getElementById('categoryComparisonChart').innerHTML = '<p class="text-gray-500">Esegui un\'analisi per visualizzare il grafico.</p>';
                document.getElementById('scoreEvolutionChart').innerHTML = '<p class="text-gray-500">Esegui analisi multiple per visualizzare l\'evoluzione.</p>';
                return;
            }

            // Renderizza la lista
            history.forEach((entry, index) => {
                const date = new Date(entry.timestamp).toLocaleString('it-IT');
                const color = entry.scores.general < 50 ? 'bg-red-100' : (entry.scores.general < 75 ? 'bg-yellow-100' : 'bg-green-100');
                listContainer.innerHTML += `
                    <div class="p-3 ${color} rounded-lg shadow-sm flex justify-between items-center text-sm">
                        <span class="font-medium">${date} | ${truncateString(entry.title, 40)}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-bold text-gray-700">Score: ${entry.scores.general}</span>
                            <button onclick="deleteHistoryEntry(${index})" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            // Renderizza i grafici nativi
            renderNativeCharts(history);
        }
        
        function deleteHistoryEntry(index) {
            let history = getHistory();
            history.splice(index, 1);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistoryTab(); // Ricarica la lista e i grafici
        }

        function getBarColor(score) {
            if (score < 50) return 'bg-red-500';
            if (score < 75) return 'bg-yellow-500';
            return 'bg-green-500';
        }

        // Funzione di rendering per i grafici NATIVI (sostituisce Chart.js)
        function renderNativeCharts(history) {
            if (!history || history.length === 0) return;

            // 1. Grafico Confronto Categorie (Bar Chart - Ultima Analisi)
            const latestScores = history[0].scores;
            const comparisonContainer = document.getElementById('categoryComparisonChart');
            
            const categoryLabels = {
                title: 'Title',
                description: 'Desc.',
                technical: 'Tecnici',
                social: 'Social'
            };

            let comparisonHtml = '';
            
            Object.keys(categoryLabels).forEach(key => {
                const score = latestScores[key];
                const colorClass = getBarColor(score);
                comparisonHtml += `
                    <div class="bar-wrapper">
                        <div class="bar-label">${categoryLabels[key]}</div>
                        <div class="bar-track">
                            <div class="bar-fill ${colorClass}" style="width: ${score}%;"></div>
                        </div>
                        <span class="ml-2 text-sm font-bold text-gray-800">${score}%</span>
                    </div>
                `;
            });
            comparisonContainer.innerHTML = comparisonHtml;


            // 2. Grafico Evoluzione Score (Timeline Semplice)
            const evolutionContainer = document.getElementById('scoreEvolutionChart');
            const evolutionHistory = history.slice().reverse(); 
            
            let evolutionHtml = `
                <div class="flex flex-col space-y-3">
                    ${evolutionHistory.map(entry => {
                        const score = entry.scores.general;
                        const colorClass = getBarColor(score);
                        const date = new Date(entry.timestamp).toLocaleDateString('it-IT');
                        
                        return `
                            <div class="flex items-center space-x-3 p-2 border-b">
                                <span class="text-xs text-gray-500 w-16">${date}</span>
                                <div class="bar-track flex-grow h-3">
                                    <div class="bar-fill ${colorClass}" style="width: ${score}%;"></div>
                                </div>
                                <span class="text-sm font-bold text-gray-800 w-8">${score}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            evolutionContainer.innerHTML = evolutionHtml;
        }
        
        // --- Checklist SEO ---
        
        const CHECKLIST_ITEMS = [
            { id: 'c1', category: 'Meta Tag Base', text: 'Il Tag Title √® compreso tra 30 e 70 caratteri.', check: (d) => d.title.length >= 30 && d.title.length <= 70 },
            { id: 'c2', category: 'Meta Tag Base', text: 'La Meta Description √® compresa tra 120 e 160 caratteri.', check: (d) => d.description.length >= 120 && d.description.length <= 160 },
            { id: 'c3', category: 'Tecnici', text: '√à presente il tag canonical URL.', check: (d) => d.canonical && d.canonical.length > 0 },
            { id: 'c4', category: 'Tecnici', text: 'Il meta robots √® impostato su index, follow.', check: (d) => d.robots.toLowerCase().includes('index') && d.robots.toLowerCase().includes('follow') },
            { id: 'c5', category: 'Tecnici', text: '√à presente il meta viewport per la responsivit√† mobile.', check: (d) => d.viewport.includes('width=device-width') },
            { id: 'c6', category: 'Social Media', text: '√à presente og:image.', check: (d) => d.og_image && d.og_image.length > 0 },
            { id: 'c7', category: 'Social Media', text: '√à presente twitter:card.', check: (d) => d.twitter_card && d.twitter_card.length > 0 },
            { id: 'c8', category: 'Strutturati', text: 'Sono presenti dati strutturati (JSON-LD).', check: (d) => d.json_ld.length > 0 },
        ];

        function loadChecklistState() {
            try {
                const state = localStorage.getItem(CHECKLIST_KEY);
                return state ? JSON.parse(state) : {};
            } catch (e) { return {}; }
        }

        function saveChecklistState(state) {
            localStorage.setItem(CHECKLIST_KEY, JSON.stringify(state));
        }

        function renderChecklist(analysisData = null) {
            const container = document.getElementById('checklist-container');
            let html = '';
            // Ottimizzazione: lo stato viene caricato solo al momento del rendering
            const state = loadChecklistState(); 
            let checkedCount = 0;
            const totalItems = CHECKLIST_ITEMS.length;
            
            CHECKLIST_ITEMS.forEach(item => {
                const isChecked = state[item.id] || false;
                const automaticCheck = analysisData ? item.check(analysisData) : null;

                if (isChecked) checkedCount++;

                let checkIcon = '‚óªÔ∏è';
                let checkColor = 'text-gray-500';

                if (automaticCheck === true) {
                    checkIcon = '‚úÖ';
                    checkColor = 'text-green-600';
                } else if (automaticCheck === false) {
                     checkIcon = '‚ùå';
                     checkColor = 'text-red-600';
                }
                
                html += `
                    <div class="flex items-center p-3 bg-white rounded-lg shadow-sm justify-between hover:bg-gray-50">
                        <label class="flex items-center cursor-pointer flex-grow">
                            <input type="checkbox" id="check-${item.id}" ${isChecked ? 'checked' : ''} onchange="toggleChecklistItem('${item.id}')" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <span class="ml-3 text-sm font-medium text-gray-700">${item.text}</span>
                        </label>
                        <span class="text-xs font-semibold ${checkColor} ml-4 flex-shrink-0">${item.category} <span class="ml-2">${checkIcon}</span></span>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div class="mb-4">
                    <div id="progress-bar-container" class="h-4 bg-gray-200 rounded-full">
                        <div id="progress-bar" class="h-4 bg-green-500 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                    <p id="progress-text" class="text-right text-sm mt-1 text-green-700 font-medium">0% Completato</p>
                </div>
            ` + html;

            updateProgress(checkedCount, totalItems);
        }

        function toggleChecklistItem(id) {
            const state = loadChecklistState();
            state[id] = !state[id];
            saveChecklistState(state);
            
            const checkbox = document.getElementById(`check-${id}`);
            if (checkbox) {
                 let checkedCount = 0;
                 CHECKLIST_ITEMS.forEach(item => {
                     if (loadChecklistState()[item.id]) checkedCount++;
                 });
                 updateProgress(checkedCount, CHECKLIST_ITEMS.length);
            }
        }
        
        function updateProgress(checkedCount, totalItems) {
            const percentage = totalItems > 0 ? Math.round((checkedCount / totalItems) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}% Completato`;
        }

        // --- Utility Functions ---
        
        function checkInputLength(event) {
            const value = event.target.value.trim();
            const analyzeButton = document.getElementById('analyze-button');
            if (value.length >= 100) {
                analyzeButton.disabled = false;
            } else {
                analyzeButton.disabled = true;
            }
        }

        function changeTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active'); 
                btn.classList.add('text-gray-300', 'hover:text-white');
            });
            
            const activeTab = document.getElementById(`tab-${tabId}`);
            const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
            
            if (activeTab) activeTab.classList.remove('hidden');
            
            if (activeButton) {
                activeButton.classList.add('active'); 
                activeButton.classList.remove('text-gray-300', 'hover:text-white');
            }

            if (tabId === 'history') {
                renderHistoryTab(); 
            }
        }
        
        function scrollToTab(tabId) {
            changeTab(tabId);
            const container = document.getElementById('results-container');
            container.scrollIntoView({ behavior: 'smooth' });
        }

        function truncateString(str, num) {
            if (!str) return '';
            if (str.length <= num) {
                return str;
            }
            return str.slice(0, num) + '...';
        }
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copiato! ‚úÖ';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Errore copia:', err);
                // Fallback per Elementor
                showCustomMessage('Copia Fallita', 'Per Elementor, la copia potrebbe non funzionare per restrizioni di sicurezza. Copia manualmente il testo.');
            });
        }
        
        // --- Export PDF ---

        function exportToPdf() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                showCustomMessage('Attenzione', 'La libreria PDF (jsPDF) non √® ancora stata caricata. Riprova tra qualche istante.');
                return;
            }

            const history = getHistory();
            
            if (history.length === 0 || !history[0]) {
                 showCustomMessage('Attenzione', 'Esegui prima un\'analisi incollando il codice HTML sorgente per poter generare il report PDF.');
                 return;
            }
            
            const data = history[0]; 
            const doc = new window.jspdf.jsPDF();
            let y = 15;
            
            doc.setFontSize(22);
            doc.text("Report Analisi SEO", 10, y);
            y += 10;
            
            doc.setFontSize(10);
            doc.text(`Sorgente: ${data.analyzedUrl}`, 10, y);
            y += 5;
            doc.text(`Data: ${new Date(data.timestamp).toLocaleString('it-IT')}`, 10, y);
            y += 10;

            doc.setFontSize(16);
            doc.text("Punteggi Globali", 10, y);
            y += 8;

            doc.setFontSize(12);
            const scores = data.scores || {};
            doc.text(`Punteggio Generale: ${scores.general || 'N/A'}/100`, 10, y);
            doc.text(`Title Score: ${scores.title || 'N/A'}/100`, 100, y);
            y += 5;
            doc.text(`Description Score: ${scores.description || 'N/A'}/100`, 10, y);
            doc.text(`Social Score: ${scores.social || 'N/A'}/100`, 100, y);
            y += 10;
            
            // Raccomandazioni (simulazione)
            doc.setFontSize(16);
            doc.text("Top Raccomandazioni", 10, y);
            y += 8;
            
            doc.setFontSize(10);
            const titleLen = data.title?.length || 0;
            const descLen = data.description?.length || 0;
            const canonicalPresent = data.canonical && data.canonical.length > 0;
            const ogImagePresent = data.og_image && data.og_image.length > 0;
            const jsonLdCount = data.json_ld_count || 0;

            doc.text(`1. Title Tag: ${titleLen > 70 ? '‚ùå Troppo Lungo' : '‚úÖ OK'} (${titleLen} car.)`, 10, y);
            y += 5;
            doc.text(`2. Meta Description: ${descLen > 160 ? '‚ùå Troppo Lunga' : (descLen < 120 ? '‚ö†Ô∏è Troppo Corta' : '‚úÖ OK')} (${descLen} car.)`, 10, y);
            y += 5;
            doc.text(`3. URL Canonico: ${canonicalPresent ? '‚úÖ Presente' : '‚ùå Mancante'}`, 10, y);
            y += 5;
            doc.text(`4. OG Image: ${ogImagePresent ? '‚úÖ Presente' : '‚ö†Ô∏è Mancante'}`, 10, y);
            y += 5;
            doc.text(`5. Dati Strutturati: ${jsonLdCount > 0 ? `‚úÖ Trovati (${jsonLdCount})` : '‚ùå Mancanti'}`, 10, y);
            y += 10;

            // Dati base
            doc.setFontSize(16);
            doc.text("Dati Estratti", 10, y);
            y += 8;
            doc.setFontSize(10);
            doc.text(`Title: ${truncateString(data.title || 'N/A', 90)}`, 10, y);
            y += 5;
            doc.text(`Description: ${truncateString(data.description || 'N/A', 90)}`, 10, y);
            y += 10;

            doc.save(`Report_SEO_Analisi_Incollata.pdf`);
        }

        window.exportToPdf = exportToPdf;
        
        // Funzione Modale/Messaggio personalizzata
        function showCustomMessage(title, message) {
            console.warn(`[MESSAGGIO: ${title}] ${message}`);
             const errorElement = document.getElementById('error-message');
             if (errorElement) {
                errorElement.textContent = `${title}: ${message}`;
                errorElement.classList.remove('hidden');
                // Uso un piccolo timeout per non nascondere subito il messaggio
                setTimeout(() => errorElement.classList.add('hidden'), 5000); 
            }
        }

        // --- Main Controller ---

        function analyzeHtml() {
            const htmlInput = document.getElementById('html-input');
            const html = htmlInput.value.trim();
            const analyzeButton = document.getElementById('analyze-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsContainer = document.getElementById('results-container');
            const errorElement = document.getElementById('error-message');
            const analyzedUrlDisplay = document.getElementById('analyzed-url-display');

            // 1. Validazione e UI Reset
            resultsContainer.classList.add('hidden');
            errorElement.classList.add('hidden');
            errorElement.textContent = '';
            
            if (!html || html.length < 100) {
                errorElement.textContent = "Per favore, incolla il codice sorgente HTML completo (deve essere pi√π lungo di 100 caratteri).";
                errorElement.classList.remove('hidden');
                return;
            }

            // Disabilita il pulsante e mostra il caricamento
            analyzeButton.disabled = true;
            loadingIndicator.classList.remove('hidden');
            analyzedUrlDisplay.textContent = `Sorgente Analizzata: Codice HTML Incollato`;

            // L'analisi √® sincrona - la lentezza qui √® un limite del browser su HTML gigantesco.
            try {
                // 2. Parsa e Calcola
                let data = parseHtml(html);
                data = calculateScores(data);

                // 3. Salva e Renderizza
                saveHistory(data);

                // Renderizza tutti i componenti
                renderScoreBreakdown(data.scores);
                renderAnalysisTables(data);
                renderSerpPreview(data);
                renderSocialPreview(data);
                renderStructuredData(data);
                renderKeywordAnalysis(data);
                renderRecommendations(data);
                renderChecklist(data); 
                
                resultsContainer.classList.remove('hidden');
                changeTab('analysis');
                // Scrolla ai risultati
                resultsContainer.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error("Errore durante l'analisi HTML:", error);
                errorElement.textContent = `Si √® verificato un errore durante il parsing dell'HTML: ${error.message}. Assicurati che il codice sia ben formato.`;
                errorElement.classList.remove('hidden');
            } finally {
                // Riabilita il pulsante e nasconde il caricamento
                analyzeButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        // Funzione di inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
             window.analyzeHtml = analyzeHtml;
             window.deleteHistoryEntry = deleteHistoryEntry;
             window.toggleChecklistItem = toggleChecklistItem;
             window.scrollToTab = scrollToTab;
             
             // Aggiunge l'event listener per abilitare il pulsante in modo robusto
             const htmlInput = document.getElementById('html-input');
             if (htmlInput) {
                 htmlInput.addEventListener('input', checkInputLength);
                 
                 // Assicura che il pulsante sia nello stato corretto all'inizio
                 checkInputLength({ target: htmlInput });
             }

             // Inizializza la checklist e lo storico
             renderChecklist();
             renderHistoryTab(); 
        });

    </script>
</body>
</html>
